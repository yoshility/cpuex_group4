# コンテスト用レイトレーサ

## 1. 入出力

- 入力
    - SLD ファイル (後述)
    - フォルダ `sld/` 以下にサンプル有り。
    - コンテストで使用するのは `contest.sld`
- 出力
	- PPM フォーマットの画像


## 2. 使い方など

- OCaml がインストールされた環境が必要。
- make すると実行ファイル min-rt ができる。
- 標準入力から SLD ファイルを入力。
- 標準出力に PPM 画像を出力。
- PPM 画像はフリーの画像ビューアで見れる。

## 3. make の注意点

- OCaml の実行ファイルパス等は環境に応じて適当に書き換えて下さい。
- OCaml のバージョンによっては make_vect 等の関数が見つからないというエラーが出る場合があります。これらの処理系では関数名の頭に "caml_" を付ければ動くようです。
	- 例えば make_vect は caml_make_vect に書き換えます。

## 4. プログラムの性質

- 一般的なアーキテクチャならコード・データ合わせて SRAM (4MB) だけで足りるはず。
- GCは不要 (プログラムの最初で割り当てた配列を使い回す)
- 関数の部分適用はしない。

## 5. コンテストに向けた改造

- コンテストでは入力と出力をシリアル回線を通して行う。
- コンテストでは `miniMLRuntime.ml` に記述されているライブラリを自作の計算機向けに実装して使う。コンパイラの組み込み関数にしても良いし、アセンブリ言語あるいは OCaml で書いたサブルーチンでも良い。
- コンテストではSLDファイルの入力と画像の出力にシリアル回線を使う。

## 6. SLDファイルのフォーマット

CG に表示する 3D 物体の大きさ、向き、座標等を記述したテキストファイル。

ソースから解析したもの。保証無し。

- `$` が頭に付いているのは非終端記号
- `F` が頭に付いているのは float
- `I` が頭に付いているのは int
- `+` は 0 回以上の繰り返し

```
$SLDファイル ::=
	$環境定義 $オブジェクト定義列 $ANDネット定義列 $ORネット定義列
```

### 6.1. 環境定義

※回転角の方向は実際に試行錯誤して調べてください。

```
$環境定義 ::=
	$スクリーン中心座標
	F視線ベクトル方向1回転角(deg)
	F視線ベクトル方向2回転角(deg)
	Fライト個数(無視されるはずだが1に固定）
	F光線ベクトル方向1回転角(deg)
	F光線ベクトル方向2回転角(deg)
	F光線強さ(一応255に固定)
```

### 6.2. オブジェクト定義列

※オブジェクト定義は60個まで

```
$オブジェクト定義列 ::=
	$オブジェクト定義+
	-1
```

※物体サイズの解釈は形状によって異なる

- 直方体 → X、Y、Z サイズ
- 無限平面 → 法線ベクトル
- 二次曲面 → 境界面を与える以下の方程式の A、B、C
    - `sgn(A)/(A*A)*X^2 + sgn(B)/(B*B)*Y^2 + sgn(C)/(C*C)*Z^2 = 1`

※色は RGB 各 0 -- 255

※テクスチャは数字で指定

0. なし
1. チェッカ
2. ストライプ
3. 同心円
4. 球面上の斑点

```
$オブジェクト定義 ::=
	Iテクスチャ
	I形状(1:直方体, 2:無限平面, 3:二次曲面)
	I反射タイプ(1:非鏡面, 2:鏡面)
	I回転の有無(0に固定)
	F物体サイズX F物体サイズY F物体サイズZ
	$オブジェクト位置
	F反転フラグ(正か負で境界面のどちら側を物体内部にするかが変わる)
	Fディフューズ(0--1)
	Fハイライト(0--255)
	F色R成分 F色G成分 F色B成分
```

### 6.3. ANDネット定義列

```
$ANDネット定義列 ::=
	ANDネット定義+
	-1
```

※各ANDネット定義は、並べたオブジェクトの共通部分オブジェクトを定義する。

```
$ANDネット定義 ::=
	オブジェクトID+
	-1
```

### 6.4. ORネット定義列

```
$ORネット定義列 ::=
	ORネット定義+
	-1
```

※各ORネットは、並べたANDネット定義全てから成る和集合オブジェクトを定義する。

※レンジプリミティブとは、この和集合オブジェクトへの交差判定のカットに使用するバウンディングオブジェクト。すなわち、このオブジェクトに視線が交差しない場合は、交差判定の処理がスキップされ、交差は無いものとして処理される。

※レンジプリミティブを定義しない場合は ID を 99 にする。

```
$ORネット定義 ::=
	レンジプリミティブオブジェクトID
	ANDネット要素ID+
	-1
```

### 6.5. 位置の指定

```
$スクリーン中心座標 ::= $XYZ座標
$オブジェクト位置 ::= $XYZ座標
$XYZ座標 ::= F座標X F座標Y F座標Z
```

## 7. ChangeLog

- v1.0 (2003/12/04)
	- 方向ベクトル初期化処理の不備を修正 (2003/11/30)
	- 円錐オブジェクトの衝突判定テーブルが作られないバグを修正 (2003/11/30)
	- 配列アクセス A.(B) のAの部分が必ず変数になるよう書き換え
- v1.1 (2021/01/16)
	- `Makefile` から `-nopervasives` を削除して、`make` でコンパイルできるように修正
	- `miniMLRuntime.ml`、`miniMLRuntime.mli` の `Alert deprecated` を取り除き、`create_array` を削除
	- `globals.ml` を OCaml でも min-caml でもコンパイルできるように修正
	- `minrt.ml` のバグとインデントを修正し、PPM のバージョン 3 と 6 を引数で切り替えられるように変更
	- `README` のフォーマット修正
